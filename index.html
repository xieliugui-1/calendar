<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥å†æŸ¥çœ‹å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #a7b0d4 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
            max-width: 700px;
            width: 100%;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            color: #333;
        }

        .month-year {
            font-size: 18px;
            color: #6b7dd1;
            font-weight: 600;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        button.today {
            background: #4CAF50;
        }

        button.today:hover {
            background: #45a049;
        }

        .calendar-wrapper {
            margin-bottom: 20px;
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .weekday {
            text-align: center;
            font-weight: 700;
            color: #3d56ca;
            padding: 10px;
            font-size: 14px;
        }

        .days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        /* åˆ†ç»„ç½‘æ ¼è§†å›¾ï¼ˆç­›é€‰åæŒ‰æ—¥æœŸé¡ºåºä»¥å¡ç‰‡ç½‘æ ¼å±•ç¤ºï¼‰ */
        .grouped-list {
            display: none;
            margin-top: 14px;
            /* åˆå§‹æœ€å°é«˜åº¦ï¼ŒJS ä¼šåœ¨æ¸²æŸ“æ—¶åŒæ­¥ä¸ºæ—¥å†åŒºåŸŸé«˜åº¦ */
            min-height: 520px;
            width: 100%;
        }

        .grouped-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
            /* ä½¿ç½‘æ ¼åœ¨å®¹å™¨é«˜åº¦å¤§äºå†…å®¹æ—¶å‚ç›´å±…ä¸­ï¼Œæå‡è§†è§‰å¹³è¡¡ */
            min-height: 100%;
            align-content: center;
            justify-items: stretch;
        }

        .grouped-tile {
            background: #fff;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            gap: 8px;
            cursor: pointer;
            min-height: 100px;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .grouped-tile:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 24px rgba(0,0,0,0.08);
        }

        .tile-date {
            font-weight: 800;
            color: #333;
            font-size: 14px;
        }

        .tile-lunar {
            color: #999;
            font-size: 12px;
        }

        .tile-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #666;
        }

        .tile-badge {
            background: #ff9800;
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
        }

        .tile-thumb {
            width: 100%;
            height: 72px;
            border-radius: 6px;
            object-fit: cover;
            background: #f5f5f5;
        }

        .day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-start;
            padding: 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #333;
            background: #f5f5f5;
            position: relative;
            font-size: 12px;
            min-height: 80px;
        }

        .day:hover {
            background: #e8e8ff;
            transform: scale(1.03);
        }

        .day.other-month {
            color: #ccc;
            background: transparent;
        }

        .day.today {
            background: #667eea;
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .day.selected {
            background: #764ba2;
            color: white;
            box-shadow: 0 4px 12px rgba(118, 75, 162, 0.4);
        }

        .day.weekend {
            color: #f44336;
        }

        .day.weekend .day-num {
            color: #f44336;
        }

        .day-num {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .day-lunar {
            font-size: 10px;
            color: #999;
            line-height: 1.2;
            margin-bottom: 6px;
        }

        .day.today .day-lunar {
            color: rgba(255,255,255,0.8);
        }

        .day.selected .day-lunar {
            color: rgba(255,255,255,0.8);
        }

        .day-holiday {
            font-size: 9px;
            color: #f44336;
            font-weight: 600;
            line-height: 1.2;
            margin-top: 4px;
        }

        .day.today .day-holiday {
            color: #fff;
        }

        .day.selected .day-holiday {
            color: #fff;
        }

        .day-important {
            border: 2px solid #ff9800;
        }

        .day-important-reason {
            font-size: 8px;
            color: #ff9800;
            font-weight: 600;
            line-height: 1.1;
            margin-top: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }

        /* æ—¥æ ¼ä¸­çš„å¿ƒæƒ…ï¼šä¸æ—¥æœŸå·åŒè¡Œï¼Œé å³æ˜¾ç¤ºï¼Œä¿è¯é—´è· */
        .day-num {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 2px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .day-mood-inline {
            font-size: 16px;
            margin-left: 6px;
            color: #333;
            vertical-align: middle;
        }

        /* å¡ç‰‡ä¸­çš„å¿ƒæƒ…æ˜¾ç¤ºï¼ˆå¾®è°ƒé—´è·ï¼‰ */
        .tile-mood {
            font-size: 16px;
            margin-left: 6px;
            vertical-align: middle;
        }

        /* ç­›é€‰åæ ·å¼ï¼šæ·¡å‡ºæˆ–éšè—ä¸åŒ¹é…æ—¥æœŸ */
        .filtered-dim {
            opacity: 0.18;
            pointer-events: none;
            filter: grayscale(80%);
        }

        .filtered-hidden {
            display: none !important;
        }

        .day.today .day-important-reason {
            color: #fff;
        }

        .day.selected .day-important-reason {
            color: #fff;
        }

        .important-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 6px;
            height: 6px;
            background: #ff9800;
            border-radius: 50%;
        }

        .diary-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 6px;
            height: 6px;
            background: #4CAF50;
            border-radius: 50%;
        }

        .quick-select {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .quick-select button {
            padding: 8px 16px;
            font-size: 12px;
            background: #e8e8ff;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .quick-select button:hover {
            background: #667eea;
            color: white;
        }

        .info-panel {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
        }

        .info-panel h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            color: #666;
            font-size: 14px;
            border-bottom: 1px solid #e8e8e8;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
        }

        .footer {
            text-align: center;
            margin-top: 20px;
            color: #999;
            font-size: 12px;
        }

        /* æ—¥è®°æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
            overflow-y: auto;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
        }

        .modal-header h2 {
            color: #333;
            font-size: 22px;
        }

        .close-btn {
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: #333;
        }

        .modal-body {
            margin-bottom: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 8px rgba(102, 126, 234, 0.2);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 150px;
        }

        .mood-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        .mood-btn {
            width: 50px;
            height: 50px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 28px;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
        }

        .mood-btn:hover {
            transform: scale(1.1);
        }

        .mood-btn.selected {
            border-color: #667eea;
            background: #f0f1ff;
            transform: scale(1.15);
        }

        .image-upload-area {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f9f9ff;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .image-upload-area:hover {
            background: #f0f1ff;
            border-color: #764ba2;
        }

        .image-upload-area.dragover {
            background: #e8e8ff;
            border-color: #764ba2;
        }

        #imageInput {
            display: none;
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .image-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: #f5f5f5;
            aspect-ratio: 1;
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-delete-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(244, 67, 54, 0.9);
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .image-item:hover .image-delete-btn {
            opacity: 1;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-footer button {
            padding: 12px 24px;
            font-size: 14px;
            cursor: pointer;
        }

        .btn-cancel {
            background: #e8e8e8;
            color: #333;
        }

        .btn-save {
            background: #667eea;
            color: white;
        }

        .btn-delete {
            background: #f44336;
            color: white;
            display: none;
        }

        /* toast æç¤ºæ ·å¼ */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            background: rgba(0,0,0,0.85);
            color: #fff;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 2200;
            opacity: 0;
            transition: opacity 0.25s ease, transform 0.25s ease;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }

        @media (max-width: 480px) {
            .container {
                padding: 20px;
            }

            .header h1 {
                font-size: 24px;
            }

            .controls {
                flex-direction: column;
                width: 100%;
            }

            button {
                width: 100%;
            }

            .day {
                min-height: 70px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“… æ—¥å†</h1>
            <div class="month-year" id="monthYear"></div>
        </div>

        <div class="controls">
            <button onclick="previousMonth()">â† ä¸Šæœˆ</button>
            <button class="today" onclick="goToday()">ä»Šå¤©</button>
            <button onclick="nextMonth()">ä¸‹æœˆ â†’</button>
        </div>

        <!-- ç­›é€‰æ§ä»¶ï¼šæŒ‰æ ‡ç­¾ç­›é€‰ -->
        <div class="controls" style="margin-top:12px; gap:8px; align-items:center;">
            <label style="font-weight:600; color:#333;">åˆ†ç±»ï¼š</label>
            <select id="tagFilter" style="padding:8px; border-radius:6px; border:1px solid #e0e0e0; min-width:160px;" onchange="onTagFilterChange()">
                <option value="">å…¨éƒ¨</option>
            </select>
            <label style="display:flex; align-items:center; gap:6px; font-size:13px; color:#666;">
                <input type="checkbox" id="onlyShowMatching" onchange="onTagFilterChange()"> åªæ˜¾ç¤ºåŒ¹é…æ—¥æœŸ
            </label>
            <button onclick="clearTagFilter()" style="background:#e8e8e8; color:#333;">æ¸…é™¤ç­›é€‰</button>
        </div>

        <div class="quick-select">
            <button onclick="goToCurrentMonth()">æœ¬æœˆ</button>
            <button onclick="goToYearOffset(-1)">å»å¹´åŒæœˆ</button>
            <button onclick="goToYearOffset(1)">æ˜å¹´åŒæœˆ</button>
        </div>

        <div class="calendar-wrapper">
            <div class="weekdays">
                <div class="weekday">æ—¥</div>
                <div class="weekday">ä¸€</div>
                <div class="weekday">äºŒ</div>
                <div class="weekday">ä¸‰</div>
                <div class="weekday">å››</div>
                <div class="weekday">äº”</div>
                <div class="weekday">å…­</div>
            </div>
            <div class="days" id="daysContainer"></div>
            <!-- åˆ†ç»„è§†å›¾ï¼šåœ¨é€‰ä¸­æ ‡ç­¾æ—¶æ˜¾ç¤ºï¼ŒæŒ‰æ—¥æœŸé¡ºåºåˆ—å‡ºåŒ¹é…æ—¥æœŸ -->
            <div id="groupedList" class="grouped-list"></div>
        </div>

        <div class="info-panel">
            <h3>ğŸ“Š æ—¥æœŸä¿¡æ¯</h3>
            <div class="info-item">
                <span class="info-label">é€‰æ‹©æ—¥æœŸ:</span>
                <span id="selectedDate">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">æ˜ŸæœŸ:</span>
                <span id="selectedDay">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">æ˜¯ç¬¬å‡ å‘¨:</span>
                <span id="weekNumber">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">æ˜¯ç¬¬å‡ å¤©:</span>
                <span id="dayOfYear">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">è·ä»Šå¤©:</span>
                <span id="daysFromToday">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">å¿ƒæƒ…:</span>
                <span id="selectedMood">-</span>
            </div>
        </div>

        <div class="footer">
            ğŸ’¡ ç‚¹å‡»æ—¥æœŸè®°å½•æ—¥è®°æˆ–æ ‡è®°é‡è¦æ—¥å­
        </div>
    </div>

    <!-- éé˜»å¡æç¤ºï¼štoast -->
    <div id="toast" class="toast" aria-live="polite" aria-atomic="true" style="display:none;"></div>

    <!-- æ—¥è®°è®°å½•æ¨¡æ€æ¡† -->
    <div id="diaryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">ğŸ“ æ—¥è®°è®°å½•</h2>
                <span class="close-btn" onclick="closeDiaryModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>é€‰æ‹©å¿ƒæƒ…</label>
                    <div class="mood-selector">
                        <button class="mood-btn" data-mood="ğŸ˜Š" title="å¼€å¿ƒ" onclick="selectMood(this)">ğŸ˜Š</button>
                        <button class="mood-btn" data-mood="ğŸ˜”" title="éš¾è¿‡" onclick="selectMood(this)">ğŸ˜”</button>
                        <button class="mood-btn" data-mood="ğŸ˜" title="å–œçˆ±" onclick="selectMood(this)">ğŸ˜</button>
                        <button class="mood-btn" data-mood="ğŸ˜´" title="ç–²æƒ«" onclick="selectMood(this)">ğŸ˜´</button>
                        <button class="mood-btn" data-mood="ğŸ˜¤" title="ç”Ÿæ°”" onclick="selectMood(this)">ğŸ˜¤</button>
                        <button class="mood-btn" data-mood="ğŸ˜" title="è‡ªä¿¡" onclick="selectMood(this)">ğŸ˜</button>
                        <button class="mood-btn" data-mood="ğŸ˜•" title="å›°æƒ‘" onclick="selectMood(this)">ğŸ˜•</button>
                        <button class="mood-btn" data-mood="ğŸ˜Œ" title="å¹³é™" onclick="selectMood(this)">ğŸ˜Œ</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>æ ‡é¢˜ (å¯é€‰)</label>
                    <input type="text" id="diaryTitle" placeholder="è¾“å…¥æ—¥è®°æ ‡é¢˜...">
                </div>

                <div class="form-group">
                    <label>å›¾ç‰‡</label>
                    <div class="image-upload-area" id="uploadArea" onclick="document.getElementById('imageInput').click()">
                        <div>ğŸ–¼ï¸</div>
                        <div style="font-weight: 600; color: #667eea; margin-bottom: 5px;">ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ‹½æ”¾å…¥å›¾ç‰‡</div>
                        <div style="font-size: 12px; color: #999;">æ”¯æŒ JPGã€PNGã€GIF | ä¹Ÿå¯ç›´æ¥ç²˜è´´</div>
                    </div>
                    <input type="file" id="imageInput" multiple accept="image/*" onchange="handleFileSelect(event)">
                    <div class="image-gallery" id="imageGallery"></div>
                </div>

                <div class="form-group">
                    <label>å†…å®¹</label>
                    <textarea id="diaryContent" placeholder="è®°å½•ä½ ä»Šå¤©çš„ç‚¹æ»´..." onpaste="handlePaste(event)"></textarea>
                </div>

                <div class="form-group">
                    <label>æ ‡ç­¾ (å¯é€‰ï¼Œç”¨é€—å·åˆ†éš”)</label>
                    <input type="text" id="diaryTags" placeholder="ä¾‹å¦‚ï¼šå·¥ä½œ, ç”Ÿæ´», æ—…æ¸¸">
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="isImportantDay" onchange="updateImportantDayUI()">
                        æ ‡è®°ä¸ºé‡è¦æ—¥å­
                    </label>
                </div>

                <div class="form-group" id="importantDayReason" style="display:none;">
                    <label>é‡è¦åŸå›  (å¯é€‰)</label>
                    <input type="text" id="importantReason" placeholder="ä¾‹å¦‚ï¼šç”Ÿæ—¥ã€çºªå¿µæ—¥ã€æˆªæ­¢æ—¥æœŸ">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeDiaryModal()">å–æ¶ˆ</button>
                <button class="btn-delete" id="deleteDiaryBtn" onclick="deleteDiary()">åˆ é™¤</button>
                <button class="btn-save" onclick="saveDiary()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥å†œå†åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/lunar-calendar/dist/lunar.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.min.js"></script>

    <script>
        // æ•°æ®å­˜å‚¨
        let currentDate = new Date();
        let selectedDate = new Date();
        let diaryData = {};
        let currentDiaryDate = null;
        let currentImages = [];
        let importantDays = {};

        const weekDayNames = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
        const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];

        // ç®€åŒ–çš„å†œå†è®¡ç®—ï¼ˆé€‚ç”¨äº1900-2100å¹´ï¼‰
        const lunarData = [
            '0,1,2,5,7,10,12,15,18,20,22,25,27,30,33,35,37,40,42,45',
            '47,50,52,55,57,60,62,65,67,69,72,74,77,79,82,84,87,89,92,94',
            '97,99,102,104,107,109,111,114,116,119,121,124,126,129,131,134,136,138,141,143'
        ];

        // åŸºäºç»å…¸å†œå†ç®—æ³•çš„å‡†ç¡®è½¬æ¢ï¼ˆæ”¯æŒ 1901-2099 å¹´ï¼‰
        function simpleLunarDay(date) {
            const lunarMonthNames = ['*', 'æ­£', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹', 'å', 'åä¸€', 'è…Š'];
            const lunarDayNames = ['*', 'åˆä¸€', 'åˆäºŒ', 'åˆä¸‰', 'åˆå››', 'åˆäº”',
                                   'åˆå…­', 'åˆä¸ƒ', 'åˆå…«', 'åˆä¹', 'åˆå',
                                   'åä¸€', 'åäºŒ', 'åä¸‰', 'åå››', 'åäº”',
                                   'åå…­', 'åä¸ƒ', 'åå…«', 'åä¹', 'äºŒå',
                                   'å»¿ä¸€', 'å»¿äºŒ', 'å»¿ä¸‰', 'å»¿å››', 'å»¿äº”',
                                   'å»¿å…­', 'å»¿ä¸ƒ', 'å»¿å…«', 'å»¿ä¹', 'ä¸‰å'];
            
            // å†œå†æ•°æ®è¡¨ï¼ˆ1901-2099å¹´ï¼‰
            const lunarCalendarTable = [
                0x04AE53, 0x0A5748, 0x5526BD, 0x0D2650, 0x0D9544, 0x46AAB9, 0x056A4D, 0x09AD42, 0x24AEB6, 0x04AE4A,
                0x6A4DBE, 0x0A4D52, 0x0D2546, 0x5D52BA, 0x0B544E, 0x0D6A43, 0x296D37, 0x095B4B, 0x749BC1, 0x049754,
                0x0A4B48, 0x5B25BC, 0x06A550, 0x06D445, 0x4ADAB8, 0x02B64D, 0x095742, 0x2497B7, 0x04974A, 0x664B3E,
                0x0D4A51, 0x0EA546, 0x56D4BA, 0x05AD4E, 0x02B644, 0x393738, 0x092E4B, 0x7C96BF, 0x0C9553, 0x0D4A48,
                0x6DA53B, 0x0B554F, 0x056A45, 0x4AADB9, 0x025D4D, 0x092D42, 0x2C95B6, 0x0A954A, 0x7B4ABD, 0x06CA51,
                0x0B5546, 0x555ABB, 0x04DA4E, 0x0A5B43, 0x352BB8, 0x052B4C, 0x8A953F, 0x0E9552, 0x06AA48, 0x6AD53C,
                0x0AB54F, 0x04B645, 0x4A5739, 0x0A574D, 0x052642, 0x3E9335, 0x0D9549, 0x75AABE, 0x056A51, 0x096D46,
                0x54AEBB, 0x04AD4F, 0x0A4D43, 0x4D26B7, 0x0D254B, 0x8D52BF, 0x0B5452, 0x0B6A47, 0x696D3C, 0x095B50,
                0x049B45, 0x4A4BB9, 0x0A4B4D, 0xAB25C2, 0x06A554, 0x06D449, 0x6ADA3D, 0x0AB651, 0x093746, 0x5497BB,
                0x04974F, 0x064B44, 0x36A537, 0x0EA54A, 0x86B2BF, 0x05AC53, 0x0AB647, 0x5936BC, 0x092E50, 0x0C9645,
                0x4D4AB8, 0x0D4A4C, 0x0DA541, 0x25AAB6, 0x056A49, 0x7AADBD, 0x025D52, 0x092D47, 0x5C95BA, 0x0A954E,
                0x0B4A43, 0x4B5537, 0x0AD54A, 0x955ABF, 0x04BA53, 0x0A5B48, 0x652BBC, 0x052B50, 0x0A9345, 0x474AB9,
                0x06AA4C, 0x0AD541, 0x24DAB6, 0x04B64A, 0x69573D, 0x0A4E51, 0x0D2646, 0x5E933A, 0x0D534D, 0x05AA43,
                0x36B537, 0x096D4B, 0xB4AEBF, 0x04AD53, 0x0A4D48, 0x6D25BC, 0x0D254F, 0x0D5244, 0x5DAA38, 0x0B5A4C,
                0x056D41, 0x24ADB6, 0x049B4A, 0x7A4BBE, 0x0A4B51, 0x0AA546, 0x5B52BA, 0x06D24E, 0x0ADA42, 0x355B37,
                0x09374B, 0x8497C1, 0x049753, 0x064B48, 0x66A53C, 0x0EA54F, 0x06B244, 0x4AB638, 0x0AAE4C, 0x092E42,
                0x3C9735, 0x0C9649, 0x7D4ABD, 0x0D4A51, 0x0DA545, 0x55AABA, 0x056A4E, 0x0A6D43, 0x452EB7, 0x052D4B,
                0x8A95BF, 0x0A9553, 0x0B4A47, 0x6B553B, 0x0AD54F, 0x055A45, 0x4A5D38, 0x0A5B4C, 0x052B42, 0x3A93B6,
                0x069349, 0x7729BD, 0x06AA51, 0x0AD546, 0x54DABA, 0x04B64E, 0x0A5743, 0x452738, 0x0D264A, 0x8E933E,
                0x0D5252, 0x0DAA47, 0x66B53B, 0x056D4F, 0x04AE45, 0x4A4EB9, 0x0A4D4C, 0x0D1541, 0x2D92B5
            ];
            
            const monthAdd = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
            
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            
            if (year < 1901 || year > 2099) {
                return 'å†œå†';
            }
            
            let springNY, sunNY;
            
            // Spring_NY è®°å½•æ˜¥èŠ‚ç¦»å½“å¹´å…ƒæ—¦çš„å¤©æ•°
            if (((lunarCalendarTable[year - 1901] & 0x0060) >> 5) === 1) {
                springNY = (lunarCalendarTable[year - 1901] & 0x001F) - 1;
            } else {
                springNY = (lunarCalendarTable[year - 1901] & 0x001F) - 1 + 31;
            }
            
            // Sun_NY è®°å½•é˜³å†æ—¥ç¦»å½“å¹´å…ƒæ—¦çš„å¤©æ•°
            sunNY = monthAdd[month - 1] + day - 1;
            if (!(year % 4) && month > 2) {
                sunNY++;
            }
            
            let lunarMonth, lunarDay, isLeap = 0;
            
            if (sunNY >= springNY) {
                // é˜³å†æ—¥åœ¨æ˜¥èŠ‚åï¼ˆå«æ˜¥èŠ‚é‚£å¤©ï¼‰
                sunNY -= springNY;
                lunarMonth = 1;
                let index = 1;
                let flag = 0;
                
                let staticDayCount = ((lunarCalendarTable[year - 1901] & (0x80000 >> (index - 1))) === 0) ? 29 : 30;
                
                while (sunNY >= staticDayCount) {
                    sunNY -= staticDayCount;
                    index++;
                    
                    if (lunarMonth === ((lunarCalendarTable[year - 1901] & 0xF00000) >> 20)) {
                        flag = flag ? 0 : 1;
                        if (flag === 0) {
                            lunarMonth++;
                        }
                    } else {
                        lunarMonth++;
                    }
                    
                    staticDayCount = ((lunarCalendarTable[year - 1901] & (0x80000 >> (index - 1))) === 0) ? 29 : 30;
                }
                
                lunarDay = sunNY + 1;
                if (lunarMonth === ((lunarCalendarTable[year - 1901] & 0xF00000) >> 20)) {
                    isLeap = 1;
                }
            } else {
                // é˜³å†æ—¥åœ¨æ˜¥èŠ‚å‰
                springNY -= sunNY;
                let targetYear = year - 1;
                lunarMonth = 12;
                
                let index = ((lunarCalendarTable[targetYear - 1901] & 0xF00000) >> 20) === 0 ? 12 : 13;
                let flag = 0;
                
                let staticDayCount = ((lunarCalendarTable[targetYear - 1901] & (0x80000 >> (index - 1))) === 0) ? 29 : 30;
                
                while (springNY > staticDayCount) {
                    springNY -= staticDayCount;
                    index--;
                    
                    if (flag === 0) {
                        lunarMonth--;
                    }
                    
                    if (lunarMonth === ((lunarCalendarTable[targetYear - 1901] & 0xF00000) >> 20)) {
                        flag = flag ? 0 : 1;
                    }
                    
                    staticDayCount = ((lunarCalendarTable[targetYear - 1901] & (0x80000 >> (index - 1))) === 0) ? 29 : 30;
                }
                
                lunarDay = staticDayCount - springNY + 1;
            }
            
            return `${lunarMonthNames[lunarMonth]}æœˆ${lunarDayNames[lunarDay]}`;
        }

/* ========== èŠ‚æ—¥è‡ªåŠ¨è®¡ç®—å¼€å§‹ ========== */
// 1. å…¬å†å›ºå®šèŠ‚æ—¥
const FIXED_HOLIDAYS = {
  '01-01': 'å…ƒæ—¦', '02-14': 'æƒ…äººèŠ‚', '03-08': 'å¦‡å¥³èŠ‚', '03-12': 'æ¤æ ‘èŠ‚',
  '04-01': 'æ„šäººèŠ‚', '05-01': 'åŠ³åŠ¨èŠ‚', '06-01': 'å„¿ç«¥èŠ‚', '07-01': 'å»ºå…šèŠ‚',
  '08-01': 'å»ºå†›èŠ‚', '09-10': 'æ•™å¸ˆèŠ‚', '10-01': 'å›½åº†èŠ‚', '12-25': 'åœ£è¯èŠ‚'
};

// 2. å¼•å…¥ lunar-javascriptï¼ˆCDN å·²å¸¦ï¼‰
// ç”Ÿæˆå…¨å¹´èŠ‚æ—¥/èŠ‚æ°”è¡¨
function initHolidays(year) {
  const map = new Map();
  // 2-1 å›ºå®šå…¬å†èŠ‚æ—¥
  for (const [md, name] of Object.entries(FIXED_HOLIDAYS)) {
    map.set(`${year}-${md}`, { name, type: 'holiday' });
  }
  // 2-2 å†œå†èŠ‚æ—¥
  ['æ˜¥èŠ‚','å…ƒå®µèŠ‚','ç«¯åˆèŠ‚','ä¸­ç§‹èŠ‚','é™¤å¤•']
    .forEach((n, i) => {
      const l = Lunar.fromYmd(year, [1,1,5,8,12][i], [1,15,5,15,30][i]);
      const s = l.getSolar();
      const k = `${s.getYear()}-${String(s.getMonth()).padStart(2,'0')}-${String(s.getDay()).padStart(2,'0')}`;
      map.set(k, { name: n, type: 'holiday' });
    });
  // 2-3 äºŒåå››èŠ‚æ°”
  const terms = ['å°å¯’','å¤§å¯’','ç«‹æ˜¥','é›¨æ°´','æƒŠè›°','æ˜¥åˆ†','æ¸…æ˜','è°·é›¨','ç«‹å¤','å°æ»¡','èŠ’ç§','å¤è‡³','å°æš‘','å¤§æš‘','ç«‹ç§‹','å¤„æš‘','ç™½éœ²','ç§‹åˆ†','å¯’éœ²','éœœé™','ç«‹å†¬','å°é›ª','å¤§é›ª','å†¬è‡³'];
  for (let i = 0; i < 24; i++) {
    const t = Solar.fromJulianDay(SolarTerms.fromIndex(year, i).getJulianDay());
    const k = `${t.getYear()}-${String(t.getMonth()).padStart(2,'0')}-${String(t.getDay()).padStart(2,'0')}`;
    map.set(k, { name: terms[i], type: 'solarterm' });
  }
  // è½¬å›æ™®é€šå¯¹è±¡ä¾›åŸä»£ç ä½¿ç”¨
  holidays = Object.fromEntries(map);
}
/* ========== èŠ‚æ—¥è‡ªåŠ¨è®¡ç®—ç»“æŸ ========== */
        // æ•°æ®æŒä¹…åŒ–
        function loadDiaryData() {
            const saved = localStorage.getItem('diaryData');
            if (saved) diaryData = JSON.parse(saved);
        }

        function saveDiaryData() {
            localStorage.setItem('diaryData', JSON.stringify(diaryData));
        }

        function loadImportantDays() {
            const saved = localStorage.getItem('importantDays');
            if (saved) importantDays = JSON.parse(saved);
        }

        function saveImportantDays() {
            localStorage.setItem('importantDays', JSON.stringify(importantDays));
        }

        // æ—¥æœŸå·¥å…·å‡½æ•°
        function getDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getDiary(date) {
            const key = getDateKey(date);
            return diaryData[key] || null;
        }

        function getDateInfo(date) {
            const dateStr = date.toISOString().split('T')[0];
            const lunarText = simpleLunarDay(date);
            const holidayInfo = holidays[dateStr];
            
            return {
                lunar: lunarText,
                holiday: holidayInfo
            };
        }

        // å›¾ç‰‡å¤„ç†
        function handleFileSelect(event) {
            const files = event.target.files;
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        currentImages.push({
                            data: e.target.result,
                            name: file.name,
                            type: file.type
                        });
                        renderImageGallery();
                    };
                    reader.readAsDataURL(file);
                }
            }
            event.target.value = '';
        }

        function handlePaste(event) {
            const items = event.clipboardData?.items;
            if (!items) return;

            for (let item of items) {
                if (item.type.startsWith('image/')) {
                    const file = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        currentImages.push({
                            data: e.target.result,
                            name: file.name || 'pasted-' + Date.now(),
                            type: file.type
                        });
                        renderImageGallery();
                    };
                    reader.readAsDataURL(file);
                    event.preventDefault();
                }
            }
        }

        // --------- æ ‡ç­¾ç­›é€‰ç›¸å…³ ---------
        let selectedTag = '';

        function getAllTagsFromDiary() {
            const tagsSet = new Set();
            Object.values(diaryData || {}).forEach(entry => {
                if (!entry.tags) return;
                entry.tags.split(',').map(t => t.trim()).filter(Boolean).forEach(t => tagsSet.add(t));
            });
            return Array.from(tagsSet).sort();
        }

        function populateTagFilter() {
            const select = document.getElementById('tagFilter');
            if (!select) return;
            const tags = getAllTagsFromDiary();
            // æ¸…ç©ºä½†ä¿ç•™ç¬¬ä¸€ä¸ªå…¨éƒ¨é€‰é¡¹
            const currentValue = select.value || '';
            select.innerHTML = '<option value="">å…¨éƒ¨</option>';
            tags.forEach(tag => {
                const opt = document.createElement('option');
                opt.value = tag;
                opt.textContent = tag;
                select.appendChild(opt);
            });
            // å¦‚æœä¹‹å‰é€‰æ‹©çš„æ ‡ç­¾è¿˜å­˜åœ¨åˆ™æ¢å¤
            if (currentValue && tags.includes(currentValue)) {
                select.value = currentValue;
                selectedTag = currentValue;
            } else {
                select.value = '';
                selectedTag = '';
            }
        }

        function renderGroupedList() {
            const container = document.getElementById('groupedList');
            container.innerHTML = '';
            if (!selectedTag) {
                container.style.display = 'none';
                return;
            }

            // æ”¶é›†åŒ¹é…çš„æ—¥æœŸé”®å¹¶æ’åºï¼ˆISO æ ¼å¼æŒ‰å­—ç¬¦ä¸²æ’åºç­‰åŒæ—¶é—´é¡ºåºï¼‰
            const matched = Object.keys(diaryData || {}).filter(key => {
                const entry = diaryData[key];
                if (!entry || !entry.tags) return false;
                const list = entry.tags.split(',').map(t => t.trim()).filter(Boolean);
                return list.includes(selectedTag);
            }).sort();

            if (matched.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'grouped-item';
                empty.textContent = `æœªæ‰¾åˆ°æ ‡ç­¾ä¸º "${selectedTag}" çš„æ—¥è®°æ¡ç›®`;
                container.appendChild(empty);
                container.style.display = 'block';
                return;
            }

            // åˆ›å»ºç½‘æ ¼å®¹å™¨
            const grid = document.createElement('div');
            grid.className = 'grouped-grid';

            matched.forEach(key => {
                const entry = diaryData[key];
                const tile = document.createElement('div');
                tile.className = 'grouped-tile';

                // æ—¥æœŸ
                const d = new Date(key + 'T00:00:00');
                const dateStr = `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
                const dateDiv = document.createElement('div');
                dateDiv.className = 'tile-date';
                dateDiv.textContent = dateStr;

                // å†œå†/èŠ‚æ—¥
                const info = getDateInfo(new Date(key + 'T00:00:00'));
                const lunarDiv = document.createElement('div');
                lunarDiv.className = 'tile-lunar';
                lunarDiv.textContent = info.lunar + (info.holiday ? (' Â· ' + info.holiday.name) : '');

                // ç¼©ç•¥å›¾ï¼ˆè‹¥æœ‰å›¾ç‰‡ï¼‰
                if (entry.images && entry.images.length) {
                    const img = document.createElement('img');
                    img.className = 'tile-thumb';
                    img.src = entry.images[0].data || entry.images[0].src || '';
                    tile.appendChild(img);
                }

                // å…ƒä¿¡æ¯ï¼ˆæ ‡é¢˜ã€å¿ƒæƒ…ã€å›¾ç‰‡æ•°ã€é‡è¦æ ‡è®°ï¼‰
                const meta = document.createElement('div');
                meta.className = 'tile-meta';
                const leftMeta = document.createElement('div');
                const titleSpan = document.createElement('span');
                titleSpan.textContent = (entry.title || '(æ— æ ‡é¢˜)');
                leftMeta.appendChild(titleSpan);
                if (entry.mood) {
                    const moodSpan = document.createElement('span');
                    moodSpan.className = 'tile-mood';
                    moodSpan.textContent = entry.mood;
                    leftMeta.appendChild(moodSpan);
                }

                const rightMeta = document.createElement('div');
                let badges = [];
                if (entry.images && entry.images.length) badges.push(`ğŸ–¼ ${entry.images.length}`);
                if (importantDays[key]) badges.push('â˜…');
                rightMeta.textContent = badges.join(' ');
                meta.appendChild(leftMeta);
                meta.appendChild(rightMeta);

                tile.appendChild(dateDiv);
                tile.appendChild(lunarDiv);
                tile.appendChild(meta);

                tile.addEventListener('click', () => {
                    selectDate(new Date(key + 'T00:00:00'));
                    openDiaryModal(new Date(key + 'T00:00:00'));
                });

                grid.appendChild(tile);
            });

            container.appendChild(grid);
            // å°†å®¹å™¨æœ€å°é«˜åº¦åŒæ­¥ä¸ºæ—¥å†åŒºåŸŸé«˜åº¦ï¼Œä¿è¯è§†è§‰ä¸€è‡´æ€§ï¼ˆå³ä½¿æ¡ç›®å¾ˆå°‘ä¹Ÿä¿ç•™ç©ºé—´ï¼‰
            const daysContainer = document.getElementById('daysContainer');
            if (daysContainer) {
                const h = daysContainer.offsetHeight;
                container.style.minHeight = h + 'px';
            }
            container.style.display = 'block';
        }

        function onTagFilterChange() {
            const select = document.getElementById('tagFilter');
            const onlyShow = document.getElementById('onlyShowMatching')?.checked;
            selectedTag = select ? select.value : '';
            // å½“é€‰ä¸­æ ‡ç­¾åï¼Œæ¸²æŸ“åˆ†ç»„è§†å›¾è€Œä¸æ˜¯å¸¸è§„æ—¥å†
            if (selectedTag) {
                // ç¡®ä¿ tag é€‰é¡¹å·²å¡«å……
                populateTagFilter();
                renderGroupedList();
                // éšè—æ—¥å†ç½‘æ ¼ï¼Œæ˜¾ç¤ºåˆ†ç»„åˆ—è¡¨
                document.getElementById('daysContainer').style.display = 'none';
            } else {
                document.getElementById('daysContainer').style.display = '';
                document.getElementById('groupedList').style.display = 'none';
            }
            renderCalendar();
        }

        function clearTagFilter() {
            const select = document.getElementById('tagFilter');
            const onlyBox = document.getElementById('onlyShowMatching');
            if (select) select.value = '';
            if (onlyBox) onlyBox.checked = false;
            selectedTag = '';
            // æ¢å¤æ—¥å†è§†å›¾
            document.getElementById('daysContainer').style.display = '';
            document.getElementById('groupedList').style.display = 'none';
            renderCalendar();
        }

        function renderImageGallery() {
            const gallery = document.getElementById('imageGallery');
            gallery.innerHTML = '';
            currentImages.forEach((img, index) => {
                const item = document.createElement('div');
                item.className = 'image-item';
                item.innerHTML = `
                    <img src="${img.data}" alt="å›¾ç‰‡">
                    <button class="image-delete-btn" onclick="deleteImage(${index})">Ã—</button>
                `;
                gallery.appendChild(item);
            });
        }

        function deleteImage(index) {
            currentImages.splice(index, 1);
            renderImageGallery();
        }

        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            if (!uploadArea) return;

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                for (let file of files) {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(evt) {
                            currentImages.push({
                                data: evt.target.result,
                                name: file.name,
                                type: file.type
                            });
                            renderImageGallery();
                        };
                        reader.readAsDataURL(file);
                    }
                }
            });
        }

        // æ—¥è®°æ¨¡æ€æ¡†
        function openDiaryModal(date) {
            currentDiaryDate = new Date(date);
            const diary = getDiary(date);
            const dateStr = date.toLocaleDateString('zh-CN');
            const dateKey = getDateKey(date);

            document.getElementById('modalTitle').textContent = `ğŸ“ æ—¥è®°è®°å½• - ${dateStr}`;

            document.getElementById('diaryTitle').value = '';
            document.getElementById('diaryContent').value = '';
            document.getElementById('diaryTags').value = '';
            document.getElementById('isImportantDay').checked = false;
            document.getElementById('importantReason').value = '';
            currentImages = [];

            document.querySelectorAll('.mood-btn').forEach(btn => btn.classList.remove('selected'));

            if (diary) {
                document.getElementById('diaryTitle').value = diary.title || '';
                document.getElementById('diaryContent').value = diary.content || '';
                document.getElementById('diaryTags').value = diary.tags || '';

                if (diary.images && diary.images.length > 0) {
                    currentImages = JSON.parse(JSON.stringify(diary.images));
                    renderImageGallery();
                }

                if (diary.mood) {
                    document.querySelectorAll('.mood-btn').forEach(btn => {
                        if (btn.dataset.mood === diary.mood) {
                            btn.classList.add('selected');
                        }
                    });
                }

                document.getElementById('deleteDiaryBtn').style.display = 'block';
            } else {
                document.getElementById('deleteDiaryBtn').style.display = 'none';
                renderImageGallery();
            }

            if (importantDays[dateKey]) {
                document.getElementById('isImportantDay').checked = true;
                document.getElementById('importantReason').value = importantDays[dateKey];
            }

            updateImportantDayUI();
            setupDragAndDrop();
            document.getElementById('diaryModal').style.display = 'block';
        }

        function closeDiaryModal() {
            document.getElementById('diaryModal').style.display = 'none';
        }

        function updateImportantDayUI() {
            const isImportant = document.getElementById('isImportantDay').checked;
            document.getElementById('importantDayReason').style.display = isImportant ? 'block' : 'none';
        }

        function selectMood(btn) {
            document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        }

        function saveDiary() {
            if (!currentDiaryDate) return;

            const title = document.getElementById('diaryTitle').value.trim();
            const content = document.getElementById('diaryContent').value.trim();
            const tags = document.getElementById('diaryTags').value.trim();
            const selectedMood = document.querySelector('.mood-btn.selected');
            const mood = selectedMood ? selectedMood.dataset.mood : '';

            if (!content) {
                alert('è¯·è¾“å…¥æ—¥è®°å†…å®¹');
                return;
            }

            const key = getDateKey(currentDiaryDate);
            diaryData[key] = {
                date: key,
                title: title,
                content: content,
                mood: mood,
                tags: tags,
                images: currentImages,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            const isImportant = document.getElementById('isImportantDay').checked;
            const importantReason = document.getElementById('importantReason').value.trim();

            if (isImportant) {
                importantDays[key] = importantReason || 'é‡è¦æ—¥å­';
            } else {
                delete importantDays[key];
            }

            saveDiaryData();
            saveImportantDays();
            closeDiaryModal();
            populateTagFilter();
            renderCalendar();
            updateInfoPanel();
            showToast('æ—¥è®°å·²ä¿å­˜');
        }

        function deleteDiary() {
            if (!currentDiaryDate) return;

            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ—¥è®°å—ï¼Ÿ')) return;

            const key = getDateKey(currentDiaryDate);
            delete diaryData[key];
            delete importantDays[key];
            saveDiaryData();
            saveImportantDays();
            closeDiaryModal();
            populateTagFilter();
            renderCalendar();
            updateInfoPanel();
            showToast('æ—¥è®°å·²åˆ é™¤');
        }

        // æ—¥å†æ¸²æŸ“
        function renderCalendar() {
            initHolidays(currentDate.getFullYear());
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            document.getElementById('monthYear').textContent = `${year}å¹´ ${monthNames[month]}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDate = firstDay.getDay();

            const daysContainer = document.getElementById('daysContainer');
            daysContainer.innerHTML = '';

            // ä¸Šæœˆæ—¥æœŸ
            const prevLastDay = new Date(year, month, 0).getDate();
            for (let i = startDate - 1; i >= 0; i--) {
                const day = document.createElement('div');
                day.className = 'day other-month';
                day.textContent = prevLastDay - i;
                daysContainer.appendChild(day);
            }

            // å½“æœˆæ—¥æœŸ
            for (let i = 1; i <= daysInMonth; i++) {
                const day = document.createElement('div');
                day.className = 'day';
                
                const currentFullDate = new Date(year, month, i);
                const today = new Date();
                const dateKey = getDateKey(currentFullDate);

                // æ—¥æœŸå·
                const dayNum = document.createElement('div');
                dayNum.className = 'day-num';
                dayNum.textContent = i;

                // å†œå†
                const dateInfo = getDateInfo(currentFullDate);
                const lunarDiv = document.createElement('div');
                lunarDiv.className = 'day-lunar';
                lunarDiv.textContent = dateInfo.lunar;

                // èŠ‚æ—¥/èŠ‚æ°”
                const holidayDiv = document.createElement('div');
                holidayDiv.className = 'day-holiday';
                if (dateInfo.holiday) {
                    holidayDiv.textContent = dateInfo.holiday.name;
                }

                day.appendChild(dayNum);
                day.appendChild(lunarDiv);
                if (dateInfo.holiday) {
                    day.appendChild(holidayDiv);
                }

                // ç­›é€‰åˆ¤å®š
                const onlyShow = document.getElementById('onlyShowMatching')?.checked;
                let matchesTag = true;
                const diaryForDay = getDiary(currentFullDate);
                if (selectedTag) {
                    if (!diaryForDay || !diaryForDay.tags) {
                        matchesTag = false;
                    } else {
                        const tagList = diaryForDay.tags.split(',').map(t => t.trim()).filter(Boolean);
                        matchesTag = tagList.includes(selectedTag);
                    }
                }

                // æ ·å¼å¤„ç†
                if (currentFullDate.toDateString() === today.toDateString()) {
                    day.classList.add('today');
                }

                if (currentFullDate.getDay() === 0 || currentFullDate.getDay() === 6) {
                    day.classList.add('weekend');
                }

                if (currentFullDate.toDateString() === selectedDate.toDateString()) {
                    day.classList.add('selected');
                }

                if (importantDays[dateKey]) {
                    day.classList.add('day-important');
                    const badge = document.createElement('div');
                    badge.className = 'important-badge';
                    day.appendChild(badge);
                    
                    // æ˜¾ç¤ºé‡è¦æ—¥å­åŸå› 
                    const reasonDiv = document.createElement('div');
                    reasonDiv.className = 'day-important-reason';
                    reasonDiv.textContent = importantDays[dateKey];
                    day.appendChild(reasonDiv);
                }

                // å¦‚æœåœ¨ç­›é€‰æ¨¡å¼ä¸‹ä¸”ä¸åŒ¹é…ï¼Œåˆ™æ ¹æ®è®¾ç½®æ·¡å‡ºæˆ–éšè—
                if (selectedTag && !matchesTag) {
                    if (onlyShow) {
                        day.classList.add('filtered-hidden');
                    } else {
                        day.classList.add('filtered-dim');
                    }
                } else {
                    // äº‹ä»¶
                    day.addEventListener('click', () => {
                        selectDate(currentFullDate);
                        setTimeout(() => openDiaryModal(currentFullDate), 100);
                    });
                }

                // æ—¥è®°æŒ‡ç¤ºï¼ˆå¦‚æœåŒ¹é…æˆ–æœªç­›é€‰ï¼‰
                if (diaryForDay && (!selectedTag || matchesTag)) {
                    const indicator = document.createElement('div');
                    indicator.className = 'diary-indicator';
                    day.appendChild(indicator);

                    // æ˜¾ç¤ºå¿ƒæƒ…è¡¨æƒ…ï¼ˆè‹¥æœ‰ï¼‰
                    if (diaryForDay.mood) {
                        const moodSpan = document.createElement('span');
                        moodSpan.className = 'day-mood-inline';
                        moodSpan.textContent = diaryForDay.mood;
                        // æŠŠå¿ƒæƒ…æ”¾å…¥ dayNum å†…ï¼Œè¿™æ ·å¿ƒæƒ…ä¸æ•°å­—åŒè¡Œï¼Œä¸ä¼šå½±å“ä¸‹æ–¹å†œå†/èŠ‚æ—¥çš„å¸ƒå±€
                        if (dayNum) {
                            dayNum.appendChild(moodSpan);
                        } else {
                            day.appendChild(moodSpan);
                        }
                    }
                }

                daysContainer.appendChild(day);
            }

            // ä¸‹æœˆæ—¥æœŸ
            const totalCells = daysContainer.children.length;
            const remainingCells = 42 - totalCells;
            for (let i = 1; i <= remainingCells; i++) {
                const day = document.createElement('div');
                day.className = 'day other-month';
                day.textContent = i;
                daysContainer.appendChild(day);
            }
        }

        // æ—¥æœŸé€‰æ‹©å’Œå¯¼èˆª
        function selectDate(date) {
            selectedDate = new Date(date);
            updateInfoPanel();
            renderCalendar();
        }

        function updateInfoPanel() {
            const year = selectedDate.getFullYear();
            const month = selectedDate.getMonth() + 1;
            const day = selectedDate.getDate();
            const dayOfWeek = selectedDate.getDay();

            document.getElementById('selectedDate').textContent = `${year}å¹´${month}æœˆ${day}æ—¥`;
            document.getElementById('selectedDay').textContent = weekDayNames[dayOfWeek];

            const firstDay = new Date(year, 0, 1);
            const pastDaysOfYear = (selectedDate - firstDay) / 86400000;
            const weekNumber = Math.ceil((pastDaysOfYear + firstDay.getDay() + 1) / 7);
            document.getElementById('weekNumber').textContent = `ç¬¬${weekNumber}å‘¨`;

            const dayOfYear = Math.floor((selectedDate - new Date(year, 0, 0)) / 86400000);
            document.getElementById('dayOfYear').textContent = `ç¬¬${dayOfYear}å¤©`;

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const selectedDateCopy = new Date(selectedDate);
            selectedDateCopy.setHours(0, 0, 0, 0);
            const diffTime = selectedDateCopy - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) {
                document.getElementById('daysFromToday').textContent = 'ä»Šå¤©';
            } else if (diffDays > 0) {
                document.getElementById('daysFromToday').textContent = `å${diffDays}å¤©`;
            } else {
                document.getElementById('daysFromToday').textContent = `å‰${Math.abs(diffDays)}å¤©`;
            }

            // æ˜¾ç¤ºæ‰€é€‰æ—¥æœŸçš„å¿ƒæƒ…ï¼ˆè‹¥æœ‰ï¼‰
            const diary = getDiary(selectedDate);
            document.getElementById('selectedMood').textContent = diary && diary.mood ? diary.mood : '-';
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function goToday() {
            currentDate = new Date();
            selectedDate = new Date();
            updateInfoPanel();
            renderCalendar();
        }

        function goToCurrentMonth() {
            currentDate = new Date();
            renderCalendar();
        }

        function goToYearOffset(offset) {
            const newDate = new Date();
            newDate.setFullYear(newDate.getFullYear() + offset);
            currentDate = newDate;
            renderCalendar();
        }

        // æ¨¡æ€æ¡†å¤–ç‚¹å‡»å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('diaryModal');
            if (event.target === modal) {
                closeDiaryModal();
            }
        }

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            loadDiaryData();
            loadImportantDays();
            populateTagFilter();
            renderCalendar();
            updateInfoPanel();
        });

        // éé˜»å¡ toast æç¤º
        function showToast(msg, duration = 1500) {
            const toast = document.getElementById('toast');
            if (!toast) return;
            toast.textContent = msg;
            toast.style.display = 'block';
            toast.classList.add('show');
            if (toast._timer) clearTimeout(toast._timer);
            toast._timer = setTimeout(() => {
                toast.classList.remove('show');
                // ç­‰åŠ¨ç”»ç»“æŸåéšè—
                setTimeout(() => toast.style.display = 'none', 250);
            }, duration);
        }
    </script>
</body>
</html>
